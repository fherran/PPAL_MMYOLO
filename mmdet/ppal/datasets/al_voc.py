# Copyright (c) OpenMMLab. All rights reserved.
import os.path as osp
import torch
import numpy as np
from typing import List, Optional

# MMDet 3.x / MMEngine Imports
from mmdet.registry import DATASETS
from mmdet.datasets.voc import VOCDataset
from mmengine.logging import print_log
from mmdet.structures import DetDataSample

@DATASETS.register_module()
class ALVOCDataset(VOCDataset):
    """VOC Dataset for Active Learning (PPAL) in MMDet 3.x.
    
    This dataset inherits from the standard VOCDataset to leverage the 
    MMEngine data-loading pipeline while adding support for PPAL-specific 
    result formatting and uncertainty extraction.
    """

    # METAINFO is the standard way to define classes in MMDet 3.x
    METAINFO = {
        'classes':
        ('aeroplane', 'bicycle', 'bird', 'boat', 'bottle', 'bus', 'car', 'cat',
         'chair', 'cow', 'diningtable', 'dog', 'horse', 'motorbike', 'person',
         'pottedplant', 'sheep', 'sofa', 'train', 'tvmonitor'),
        'palette': [(106, 0, 228), (119, 11, 32), (165, 42, 42), (0, 0, 192),
                    (197, 226, 255), (0, 60, 100), (0, 0, 142), (255, 77, 255),
                    (153, 69, 1), (120, 166, 157), (0, 182, 199),
                    (0, 226, 252), (182, 182, 182), (0, 0, 230), (80, 50, 50),
                    (0, 0, 70), (0, 0, 21), (0, 60, 100), (0, 80, 100),
                    (0, 0, 110)]
    }

    def __init__(self, **kwargs):
        """Initialize the Active Learning VOC dataset.
        
        In 3.x, BaseDetDataset handles annotation loading and image prefixes 
        differently than the old XMLDataset.
        """
        super().__init__(**kwargs)

    def _det2json(self, results: List[DetDataSample]) -> List[dict]:
        """Convert detection results to a list of dicts for PPAL sampling.
        
        This refactored method extracts the entropy-based uncertainties 
        generated by our custom RetinaHeadUncertainty.
        """
        json_results = []
        for idx in range(len(self)):
            # Get metadata for the current image
            img_info = self.get_data_info(idx)
            img_id = img_info.get('img_id', idx)
            
            # results[idx] is a DetDataSample in MMDet 3.x
            data_sample = results[idx]
            pred_instances = data_sample.pred_instances
            
            # Move to CPU for serialization
            bboxes = pred_instances.bboxes.cpu().numpy()
            scores = pred_instances.scores.cpu().numpy()
            labels = pred_instances.labels.cpu().numpy()
            
            # Extract PPAL-specific uncertainties
            if 'cls_uncertainties' in pred_instances:
                uncertainties = pred_instances.cls_uncertainties.cpu().numpy()
            else:
                # Fallback if uncertainty was not calculated
                uncertainties = np.zeros_like(scores)

            for i in range(len(labels)):
                data = dict()
                data['image_id'] = img_id
                
                # Convert [x1, y1, x2, y2] to COCO [x, y, w, h] format
                x1, y1, x2, y2 = bboxes[i]
                data['bbox'] = [
                    float(x1), 
                    float(y1), 
                    float(x2 - x1), 
                    float(y2 - y1)
                ]
                
                data['score'] = float(scores[i])
                data['cls_uncertainty'] = float(uncertainties[i])
                data['category_id'] = int(labels[i])
                json_results.append(data)
                
        return json_results

    def format_results(self, 
                       results: List[DetDataSample], 
                       jsonfile_prefix: Optional[str] = None, 
                       **kwargs) -> tuple:
        """Format results to JSON style for the active learning sampler."""
        import mmengine
        import tempfile
        
        assert isinstance(results, list), 'results must be a list'
        
        if jsonfile_prefix is None:
            tmp_dir = tempfile.TemporaryDirectory()
            jsonfile_prefix = osp.join(tmp_dir.name, 'results')
        else:
            tmp_dir = None
            
        result_files = dict()
        json_results = self._det2json(results)
        
        result_files['bbox'] = f'{jsonfile_prefix}.bbox.json'
        mmengine.dump(json_results, result_files['bbox'])
        
        return result_files, tmp_dir